<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
    <style type="text/css">
      .row {
        margin-bottom: 8px;
      }
    </style>
  </head>
  <body>
    <div class="row">
      <label>用户名：<input id="username"/></label>
      <label>密码：<input id="password"/></label>
      <label>验证码：<input id="verify-code"/><img id="verify-img" style="vertical-align: bottom;"/></label>
    </div>
    <div id="mfa" style="visibility: hidden;" class="row">
      <label>MFA 口令：<input type="number" id="mfa-code"/></label>
    </div>
    <div class="row">
      <input type="button" value="登录" id="login" onclick="handleLogin()" />
      <input
        type="button"
        value="注册"
        id="register"
        onclick="handleRegister()"
      />
      <input
        type="button"
        value="开启 MFA"
        id="register"
        onclick="handleChangeMFA()"
      />
    </div>
    <div id="qrcode" class="row"></div>
    <div id="qrcode-info" style="visibility: hidden;" class="row">
      请使用 MFA 令牌管理工具扫码添加令牌
    </div>
    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/authing-js-sdk"></script>
    <script>
      const auth = new Authing({
        clientId: "5c95905578fce5000166f853",
        timestamp: Math.round(new Date() / 1000),
        nonce: Math.ceil(Math.random() * Math.pow(10, 6))
      });
      auth.then(authing => {
        // authing.login
        // authing.register
        // ...
        window.validAuth = authing;
      });
    </script>
    <script>
      window.isMFAShow = false;
      function showMFAInput() {
        isMFAShow = true;
        document.getElementById("mfa").style.visibility = "visible";
      }
      // 开启用户的 MFA
      async function handleChangeMFA() {
        let username = document.getElementById("username").value;
        let password = document.getElementById("password").value;
        let verifyCode = document.getElementById("verify-code").value;

        try {
          let res = await validAuth.login({
            email: username,
            password: password,
            verifyCode: verifyCode
          });
          // 或者使用用户的 token 初始化
          // authing.initUserClient('用户的 JWT token');
          let mfa = await validAuth.changeMFA({
            userId: res._id,
            userPoolId: "5c95905578fce5000166f853",
            enable: true
          });
          alert(JSON.stringify(mfa));
          jQuery("#qrcode").qrcode(
            `otpauth://totp/Authing:Test?secret=${mfa.shareKey}&period=30&digits=6&issuer=Authing`
          );
          document.getElementById("qrcode-info").style.visibility = "visible";
        } catch (err) {
          alert("失败消息：" + JSON.stringify(err));
        }
      }
      // 使用随机信息注册一个用户
      async function handleRegister() {
        let rand = Math.random()
          .toString(36)
          .slice(2);
        let res = await validAuth.register({
          email: rand + "@test.com",
          password: "123456"
        });
        alert(JSON.stringify(res));
        document.getElementById("username").value = res.email;
        document.getElementById("password").value = "123456";
        window.userId = res._id;
      }
      // 登录逻辑
      async function handleLogin() {
        // validAuth.login({email: })
        let username = document.getElementById("username").value;
        let password = document.getElementById("password").value;
        let verifyCode = document.getElementById("verify-code").value;
        if (isMFAShow) {
          let MFACode = document.getElementById("mfa-code").value;
          try {
            let res = await validAuth.login({
              email: username,
              password: password,
              MFACode: MFACode,
              verifyCode: verifyCode
            });
            alert("成功消息：" + JSON.stringify(res));
          } catch (err) {
            alert("失败消息：" + JSON.stringify(err));
            if(err.message.code === 2000 || err.message.code === 2001 || err.message.code === 2006) {
              console.log(err.message.data.url)
              document.getElementById("verify-img").src = err.message.data.url
            }
          }
        } else {
          try {
            let res = await validAuth.login({
              email: username,
              password: password,
              verifyCode: verifyCode
            });
            alert("成功消息：" + JSON.stringify(res));
          } catch (err) {
            alert("失败消息：" + JSON.stringify(err));

            if (err.message.code === 1635) {
              showMFAInput();
            }
            if(err.message.code === 2000 || err.message.code === 2001 || err.message.code === 2006) {
              console.log(err.message.data.url)
              document.getElementById("verify-img").src = err.message.data.url
            }
          }
        }
      }
    </script>
  </body>
</html>
